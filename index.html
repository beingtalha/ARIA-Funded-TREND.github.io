<!DOCTYPE html>
<html>
<head>
    <title>TREND Visualization</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
</head>
<body>
    <h1>ARIA-Funded TREND Visualization</h1>
    
    <script type="py" config='{"packages":["numpy", "plotly"]}'>
import numpy as np
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import plotly.figure_factory as ff

# =========================
# Colab-ready cell (Φ_sym ONLY)
# Interactive Plotly: contours + gradient arrows + mental-state overlays
# TERM-BASED regime coloring (theory aligned)
# =========================


import numpy as np
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import plotly.figure_factory as ff

# -------------------------
# Helpers for snapping defaults
# -------------------------
def nearest_index(arr, val):
    arr = np.asarray(arr, dtype=float)
    return int(np.argmin(np.abs(arr - float(val))))

# -------------------------
# Φ_sym ONLY: R^2 + 2R + C(1+|R|)
# plus analytic term decomposition used for regime coloring
# -------------------------
def compute_terms(RR, CC, aR=1.0, aC=1.0):
    R = aR * RR
    C = aC * CC

    # Φ_sym
    Phi = R**2 + 2*R + C*(1 + np.abs(R))

    # Term magnitudes (theory-aligned for regimes)
    fR_abs = np.abs(R**2 + 2*R)            # evidence-only
    fC_abs = np.abs(C)                    # pure context magnitude
    g_abs  = np.abs(C) * (1 + np.abs(R))  # interaction / context-gated evidence contribution

    return R, C, Phi, fR_abs, fC_abs, g_abs

def gradient_numeric(Phi, R, C):
    Phi = np.asarray(Phi)
    R = np.asarray(R).ravel()
    C = np.asarray(C).ravel()
    dR = R[1] - R[0]
    dC = C[1] - C[0]
    dPhi_dC, dPhi_dR = np.gradient(Phi, dC, dR)
    return dPhi_dR, dPhi_dC

def quiver_traces(RR, CC, dR, dC, step=6, scale=0.30, arrow_scale=0.35, line_width=1, normalize=True):
    xs = RR[::step, ::step].ravel()
    ys = CC[::step, ::step].ravel()
    us = dR[::step, ::step].ravel()
    vs = dC[::step, ::step].ravel()

    if normalize:
        mag = np.sqrt(us*us + vs*vs)
        mag[mag == 0] = 1.0
        us, vs = us/mag, vs/mag

    qfig = ff.create_quiver(
        xs, ys, us, vs,
        scale=scale,
        arrow_scale=arrow_scale,
        line_width=line_width
    )
    return list(qfig.data)

# -------------------------
# TERM-BASED mental-state map (for Φ_sym)
# -------------------------
STATE_RGBA = {
    0: "rgba(0,0,0,0.0)",          # transition / mixed
    1: "rgba(150,150,150,0.45)",   # SW/off
    2: "rgba(0,120,255,0.45)",     # AA
    3: "rgba(255,140,0,0.45)",     # AD
    4: "rgba(0,180,120,0.45)",     # AD + Awake
}

STATE_COLORSCALE = [
    [0.00, STATE_RGBA[0]], [0.2499, STATE_RGBA[0]],
    [0.25, STATE_RGBA[1]], [0.4999, STATE_RGBA[1]],
    [0.50, STATE_RGBA[2]], [0.7499, STATE_RGBA[2]],
    [0.75, STATE_RGBA[3]], [0.9999, STATE_RGBA[3]],
    [1.00, STATE_RGBA[4]],
]

def state_map_terms(fR_abs, fC_abs, g_abs, off_thr=0.60, dom_ratio=2.0, awake_thr=1.5):
    eps = 1e-9
    S = np.zeros_like(fR_abs, dtype=int)

    strength = fR_abs + fC_abs + g_abs
    off = strength < off_thr
    S[off] = 1
    nonoff = ~off

    # AD+Awake: all strong
    both_strong = (fR_abs >= awake_thr) & (fC_abs >= awake_thr) & (g_abs >= awake_thr)
    S[nonoff & both_strong] = 4

    # AA: evidence dominates
    aa = nonoff & (S == 0) & (fR_abs > dom_ratio*(fC_abs + eps)) & (fR_abs > dom_ratio*(g_abs + eps))
    S[aa] = 2

    # AD: context dominates
    ad = nonoff & (S == 0) & (fC_abs > dom_ratio*(fR_abs + eps)) & (fC_abs > dom_ratio*(g_abs + eps))
    S[ad] = 3

    return S

def state_heatmap_trace(R, C, S, opacity=0.55):
    return go.Heatmap(
        x=R, y=C, z=S,
        zmin=0, zmax=4,
        colorscale=STATE_COLORSCALE,
        showscale=False,
        opacity=opacity,
        hoverinfo="skip"
    )

# -------------------------
# Grid + options
# -------------------------
Rmax, Cmax, grid = 10, 10, 75
R = np.linspace(-Rmax, Rmax, grid)
C = np.linspace(-Cmax, Cmax, grid)
RR, CC = np.meshgrid(R, C)

aR_options = np.array([0.0, 0.5, 1.0, 2.0, 3.0], dtype=float)
aC_values  = np.round(np.linspace(-3.0, 3.0, 25), 2)

default_aR = 1.0
default_aC = 0.6

# Snap defaults (prevents IndexError)
iR = nearest_index(aR_options, default_aR)
iC = nearest_index(aC_values,  default_aC)
default_aR = float(aR_options[iR])
default_aC = float(aC_values[iC])

# -------------------------
# Initial figure
# -------------------------
Rv0, Cv0, Phi0, fR0, fC0, g0 = compute_terms(RR, CC, aR=default_aR, aC=default_aC)
dR0, dC0 = gradient_numeric(Phi0, R, C)
S0 = state_map_terms(fR0, fC0, g0)

qtr0 = quiver_traces(RR, CC, dR0, dC0, step=6, scale=0.30, arrow_scale=0.35, line_width=1, normalize=True)
n_quiver_traces = len(qtr0)

fig = make_subplots(
    rows=1, cols=2,
    subplot_titles=("Φ_sym surface (contours) + regimes", "Gradient field ∇Φ_sym + regimes")
)

fig.add_trace(
    go.Contour(x=R, y=C, z=Phi0, contours_coloring="heatmap",
               showscale=True, colorbar=dict(title="Φ_sym"), opacity=0.90),
    row=1, col=1
)
fig.add_trace(state_heatmap_trace(R, C, S0, opacity=0.40), row=1, col=1)

fig.add_trace(state_heatmap_trace(R, C, S0, opacity=0.55), row=1, col=2)
for tr in qtr0:
    fig.add_trace(tr, row=1, col=2)

for col in [1, 2]:
    fig.update_xaxes(title_text="R", row=1, col=col)
    fig.update_yaxes(title_text="C", row=1, col=col)

# -------------------------
# Frames (ONLY vary aR and aC)
# -------------------------
frames = []
for aR in aR_options:
    for aC in aC_values:
        _, _, Phi, fR, fC, g = compute_terms(RR, CC, aR=float(aR), aC=float(aC))
        dR, dC = gradient_numeric(Phi, R, C)
        S = state_map_terms(fR, fC, g)

        qtr = quiver_traces(RR, CC, dR, dC, step=6, scale=0.30, arrow_scale=0.35, line_width=1, normalize=True)
        if len(qtr) != n_quiver_traces:
            qtr = (qtr + [qtr[-1]] * n_quiver_traces)[:n_quiver_traces]

        name = f"aR={aR}__aC={aC}"
        frame_data = [
            go.Contour(x=R, y=C, z=Phi, contours_coloring="heatmap", showscale=True, opacity=0.90),
            state_heatmap_trace(R, C, S, opacity=0.40),
            state_heatmap_trace(R, C, S, opacity=0.55),
        ] + qtr

        frames.append(go.Frame(
            name=name,
            data=frame_data,
            layout=go.Layout(title_text=f"Φ_sym = R² + 2R + C(1+|R|)   (R strength={aR}, C strength={aC})")
        ))

fig.frames = frames

def frame_name(aR, aC):
    return f"aR={aR}__aC={aC}"

# -------------------------
# Controls (ONLY aR dropdown + aC slider)
# -------------------------
slider_steps = [
    dict(method="animate",
         args=[[frame_name(default_aR, aC)],
               dict(mode="immediate", frame=dict(duration=0, redraw=True), transition=dict(duration=0))],
         label=str(aC))
    for aC in aC_values
]

sliders = [dict(
    active=iC,
    currentvalue=dict(prefix="C strength: "),
    pad=dict(t=40),
    steps=slider_steps
)]

aR_buttons = []
for aR in aR_options:
    label = "R = 0" if float(aR) == 0.0 else f"{aR}"
    aR_buttons.append(dict(
        label=label,
        method="animate",
        args=[[frame_name(float(aR), default_aC)],
              dict(mode="immediate", frame=dict(duration=0, redraw=True), transition=dict(duration=0))]
    ))

fig.update_layout(
    height=630,
    width=1280,
    sliders=sliders,
    updatemenus=[
        dict(type="dropdown", x=0.62, y=1.18, showactive=True, buttons=aR_buttons, direction="down",
             bgcolor="white", bordercolor="black", borderwidth=1, pad=dict(r=10, t=0))
    ],
    annotations=[
        dict(text="R strength", x=0.62, y=1.24, xref="paper", yref="paper", showarrow=False),
    ],
)

fig.add_annotation(
    x=1.05, y=1.2, xref="paper", yref="paper",
    showarrow=False,
    align="left",
    text=(
        "<b>States (term-based, theory-aligned)</b><br>"
        "<span style='color:grey'>■</span> SW/off: all terms weak<br>"
        "<span style='color:blue'>■</span> AA: evidence-drive dominates<br>"
        "<span style='color:orange'>■</span> AD: context-drive dominates<br>"
        "<span style='color:green'>■</span> AD + Awake: evidence, context, and interaction all strong"
    )
)

display(fig, target="plot-target")
    </script>
</body>
</html>
